var __defProp = Object.defineProperty;
var __markAsModule = (target) => __defProp(target, "__esModule", {value: true});
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, {get: all[name], enumerable: true});
};

// packages/@lwrjs/shared-utils/src/env.ts
__markAsModule(exports);
__export(exports, {
  B3_PARENT_ID: () => B3_PARENT_ID,
  B3_SAMPLED: () => B3_SAMPLED,
  B3_SPAN_ID: () => B3_SPAN_ID,
  B3_TRACE_ID: () => B3_TRACE_ID,
  CORRELATION_ID: () => CORRELATION_ID,
  FORWARDED: () => FORWARDED,
  MRT_REQUEST_CLASS: () => MRT_REQUEST_CLASS,
  REQUEST_DEPTH_HEADER: () => REQUEST_DEPTH_HEADER,
  TRUE_CLIENT_IP: () => TRUE_CLIENT_IP,
  buildEnvironmentContext: () => buildEnvironmentContext,
  getFeatureFlags: () => getFeatureFlags,
  getTraceHeaders: () => getTraceHeaders,
  isLambdaEnv: () => isLambdaEnv,
  isLocalAuthEnabled: () => isLocalAuthEnabled,
  isLocalDev: () => isLocalDev,
  isLocalPreview: () => isLocalPreview,
  isMrtBundle: () => isMrtBundle,
  parseRequestDepth: () => parseRequestDepth
});
if (getFeatureFlags().REEVALUATE_MODULES && !getFeatureFlags().LEGACY_LOADER) {
  throw new Error("REEVALUATE_MODULES is only supported with LEGACY_LOADER");
}
function getFeatureFlags() {
  return {
    ASSETS_ON_LAMBDA: parseBooleanFlag("ASSETS_ON_LAMBDA"),
    BUNDLE_CACHE_SIZE: parseStringFlag("BUNDLE_CACHE_SIZE"),
    ENABLE_NONCE: parseBooleanFlag("ENABLE_NONCE"),
    EXPERIMENTAL_UNVERSIONED_ALIASES: parseBooleanFlag("EXPERIMENTAL_UNVERSIONED_ALIASES"),
    LEGACY_LOADER: parseBooleanFlag("LEGACY_LOADER"),
    LWR_TRACING: parseTracingFlag(),
    DISABLE_B3_TRACING: parseBooleanFlag("DISABLE_B3_TRACING"),
    MRT_B3_TRACING: parseBooleanFlag("MRT_B3_TRACING"),
    MAX_VIEW_CACHE_TTL: parseStringFlag("MAX_VIEW_CACHE_TTL"),
    REEVALUATE_MODULES: parseBooleanFlag("REEVALUATE_MODULES"),
    SSR_COMPILER_ENABLED: parseBooleanFlag("SSR_COMPILER_ENABLED"),
    SSR_LOADER_PER_REQUEST: parseBooleanFlag("SSR_LOADER_PER_REQUEST"),
    VIEW_CACHE_SIZE: parseStringFlag("VIEW_CACHE_SIZE"),
    EXPERIMENTAL_ASSET_HEADERS: parseStringFlag("EXPERIMENTAL_ASSET_HEADERS"),
    SSR_TIMEOUT: parseStringFlag("SSR_TIMEOUT"),
    PRELOAD_INCLUDED_MODULES: parseBooleanFlag("PRELOAD_INCLUDED_MODULES"),
    DATA_PROVIDER_METRICS: parseBooleanFlag("DATA_PROVIDER_METRICS")
  };
}
function parseBooleanFlag(flag) {
  return process.env[flag]?.toLowerCase() === "true" || false;
}
function parseStringFlag(flag) {
  const value = process.env[flag]?.trim();
  return value || void 0;
}
function parseTracingFlag() {
  const tracingValue = process.env.LWR_TRACING?.toLowerCase();
  return tracingValue && tracingValue !== "off" ? process.env.LWR_TRACING : void 0;
}
function shouldEnableB3Headers() {
  const flags = getFeatureFlags();
  const isMRT = isLambdaEnv() || process.env.MRT_REQUEST_CLASS || process.env.MOBIFY_PROPERTY_ID;
  if (isMRT) {
    return flags.MRT_B3_TRACING !== false;
  }
  return true;
}
function isLambdaEnv() {
  return process.env.AWS_LAMBDA_FUNCTION_NAME !== void 0;
}
function isMrtBundle() {
  return isLambdaEnv() || isLocalDev() || process.env.MRT_PREVIEW === "true";
}
function isLocalDev() {
  return process.env.MRT_HMR === "true";
}
function isLocalPreview() {
  return process.env.LOCAL_PREVIEW_MODE === "true";
}
function isLocalAuthEnabled() {
  return process.env.AUTH_TOKEN !== void 0;
}
function buildEnvironmentContext(runtimeParams) {
  const basePath = runtimeParams.basePath;
  const locale = runtimeParams.locale;
  const assetBasePath = runtimeParams.assetBasePath;
  const uiBasePath = runtimeParams.uiBasePath;
  return {
    basePath,
    locale,
    assetBasePath,
    uiBasePath
  };
}
var TRUE_CLIENT_IP = "true-client-ip";
var CORRELATION_ID = "x-correlation-id";
var B3_TRACE_ID = "x-b3-traceid";
var B3_SPAN_ID = "x-b3-spanid";
var B3_PARENT_ID = "x-b3-parentspanid";
var B3_SAMPLED = "x-b3-sampled";
var FORWARDED = "forwarded";
var MRT_REQUEST_CLASS = "x-mobify-request-class";
var REQUEST_DEPTH_HEADER = "x-sfdc-request-depth";
function parseRequestDepth(headers = {}, query = {}) {
  let maxDepth = 0;
  const value = headers && headers[REQUEST_DEPTH_HEADER];
  if (value) {
    if (Array.isArray(value)) {
      for (const depth of value) {
        if (typeof depth === "string") {
          const depthValue = parseInt(depth, 10);
          if (!isNaN(depthValue) && depthValue > maxDepth) {
            maxDepth = depthValue;
          }
        }
      }
    } else if (typeof value === "string") {
      const depth = parseInt(value, 10);
      if (!isNaN(depth) && depth > maxDepth) {
        maxDepth = depth;
      }
    }
  }
  if (query[REQUEST_DEPTH_HEADER]) {
    const queryValue = parseInt(query[REQUEST_DEPTH_HEADER], 10);
    if (!isNaN(queryValue) && queryValue > maxDepth) {
      maxDepth = queryValue;
    }
  }
  return maxDepth;
}
function getTraceHeaders(runtimeParams, span) {
  const headers = {};
  if (runtimeParams.trueClientIP)
    headers[TRUE_CLIENT_IP] = runtimeParams.trueClientIP;
  if (runtimeParams.correlationID)
    headers[CORRELATION_ID] = runtimeParams.correlationID;
  if (shouldEnableB3Headers()) {
    if (span?.traceId) {
      headers[B3_TRACE_ID] = span.traceId;
      headers[B3_SAMPLED] = parseTracingFlag() ? "1" : "0";
    }
    if (span?.spanId)
      headers[B3_SPAN_ID] = span.spanId;
    if (span?.parentSpanId)
      headers[B3_PARENT_ID] = span.parentSpanId;
  }
  return headers;
}
